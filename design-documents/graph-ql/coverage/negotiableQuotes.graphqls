type Query {
    # Implementation Note: Negotiable Quotes belong to the Query type,
    # rather than the Customer type, because managers
    # in a company can see quotes belonging to their
    # employees. If `Customer.negotiable_quotes` is desirable for buyer's
    # that aren't managers, we can always add that on
    negotiable_quote(id: ID!): NegotiableQuote @doc(description: "Get a buyer's NegotiableQuote by ID")
    negotiable_quotes(
        filter: NegotiableQuoteFilterInput,
        pageSize: Int = 20,
        currentPage: Int = 1
    ): [NegotiableQuote] @doc(description: "A (optionally filtered) list of Negotiable Quotes viewable by the logged-in customer")
}

# Coverage missing:
#   - Negotiable Quote Checkout Process (once seller has approved the quote)
#   - File Upload (depends on reaching consensus on file upload design - design is in internal wiki)
type Mutation {
    # https://docs.magento.com/user-guide/sales/quote-request.html
    requestNegotiableQuote(
        input: RequestNegotiableQuoteInput!
    ): RequestNegotiableQuoteOutput @doc(description: "Request a new Negotiable Quote for a buyer")

    # Covers "Add your Comment" section of https://docs.magento.com/user-guide/customers/account-dashboard-quotes-negotiate.html#shipping-information
    addNegotiableQuoteComment(
        input: AddNegotiableQuoteCommentInput!
    ): AddNegotiableQuoteCommentOutput @doc(description: "Append a new comment from the buyer to a Negotiable Quote")

    # https://docs.magento.com/user-guide/customers/account-dashboard-quotes-negotiate.html#change-the-quantity
    updateNegotiableQuoteQuantities(
        input: UpdateNegotiableQuoteQuantitiesInput!
    ): UpdateNegotiableQuoteItemsQuantityOutput @doc(description: "Change the quantity of 1 or more items already in a NegotiableQuote")

    # Covers "Delete Line Item" section of https://docs.magento.com/user-guide/customers/account-dashboard-quotes-negotiate.html#tabbed-sections
    removeNegotiableQuoteItems(
        input: RemoveNegotiableQuoteItemsInput!
    ): RemoveNegotiableQuoteItemsOutput @doc(description: "Remove 1 or more products from a Negotiable Quote")

    # Covers "buyer can add items" of https://devdocs.magento.com/guides/v2.4/b2b/negotiable-update.html#add-a-new-quote-item-to-the-negotiable-quote
    addNegotiableQuoteItems(
        input: AddNegotiableQuoteItemsInput!
    ): AddNegotiableQuoteItemsOutput @doc(description: "Add 1 or more products to a Negotiable Quote")

    # Covers first half of https://docs.magento.com/user-guide/customers/account-dashboard-quotes.html#cancel-a-quote-request
    closeNegotiableQuotes(
        input: CloseNegotiableQuotesInput!
    ): CloseNegotiableQuotesOutput @doc(description: "Mark a Negotiable Quote as closed, leaving it visible in the storefront")

    # Covers second half of https://docs.magento.com/user-guide/customers/account-dashboard-quotes.html#cancel-a-quote-request
    deleteNegotiableQuotes(
        input: DeleteNegotiableQuotesInput!
    ): DeleteNegotiableQuotesOutput @doc(description: "Delete a Negotiable Quote, removing it from the display in the storefront")

    # Covers "Select Existing Address" in https://docs.magento.com/user-guide/customers/account-dashboard-quotes-negotiate.html#shipping-information
    # "New Address" flow is covered by Mutation.createCustomerAddress
    setNegotiableQuoteShippingAddress(
        input: SetNegotiableQuoteShippingAddressInput!
    ): SetNegotiableQuoteShippingAddressOutput @doc(description: "Assign one of buyers' existing addresses to a Negotiable Quote")

    # Pending decision on design of file upload (design doc still pending decisions)
    # addNegotiableQuoteFiles(
    #     input: AddNegotiableQuoteFilesInput!
    # ): AddNegotiableQuoteFilesInput
}

type AddNegotiableQuoteItemsOutput {
    quote: NegotiableQuote
    # TODO: We'll probably want to add the same
    #       errors that can happen when adding an item
    #       to a normal cart object
}

input SetNegotiableQuoteShippingAddressInput {
    quote_id: ID! @doc(description: "ID obtained from NegotiableQuote type")
    customer_address_id: ID! @doc(
        description: "ID obtained from the CustomerAddress type. A new address can be added using Mutation.createCustomerAddress"
    )
}

type SetNegotiableQuoteShippingAddressOutput {
    quote: NegotiableQuote
}

input AddNegotiableQuoteItemsInput {
    quote_id: ID! @doc(description: "ID from a NegotiableQuote object")
    cart_items: [CartItemInput!]!
}

input DeleteNegotiableQuotesInput {
    quote_ids: [ID!]! @doc(description: "A List of IDs obtained from NegotiableQuote types")
}

type DeleteNegotiableQuotesOutput {
    # Implementation Note: We don't make the deleted quotes accessible
    # because "deleted" means they're hidden from the storefront UI. They will
    # still be visible (and labeled as deleted) for a Seller in the admin
    negotiable_quotes(
        filter: NegotiableQuoteFilterInput,
        pageSize: Int = 20,
        currentPage: Int = 1
    ): [NegotiableQuote]! @doc(description: "List of negotiable quotes available to customer")
}

input CloseNegotiableQuotesInput {
    quote_ids: [ID!]! @doc(description: "A List of IDs obtained from NegotiableQuote types")
}

type CloseNegotiableQuotesOutput {
    closed_quotes: [NegotiableQuote]! @doc(description: "Quotes that were just closed")
    negotiable_quotes(
        filter: NegotiableQuoteFilterInput,
        pageSize: Int = 20,
        currentPage: Int = 1
    ): [NegotiableQuote] @doc(description: A (optionally filtered) list of Negotiable Quotes viewable by the logged-in customer")
}

input RemoveNegotiableQuoteItemsInput {
    quote_ID: ID!
    quote_item_ids: [ID!]!
}

input UpdateNegotiableQuoteQuantitiesInput {
    quote_id: ID!
    items: [NegotiableQuoteItemQuantityInput!]!
}

input NegotiableQuoteItemQuantityInput {
    quote_item_id: ID!
    quantity: Float!
}

input RequestNegotiableQuoteInput {
    cart_id: ID!
    quote_name: String!
    comment: NegotiableQuoteCommentInput!
    # files (attachments) to be added at a later date when file upload design has been finalized
}

input NegotiableQuoteCommentInput {
    comment: String!
    # files (attachments) to be added at a later date when file upload design has been finalized
}

input AddNegotiableQuoteCommentInput {
    quote_id: ID!
    comment: NegotiableQuoteCommentInput!
}

type NegotiableQuoteComment {
    id: ID!
    created_at: String!
    author: NegotiableQuoteUser!
    creator_type: NegotiableQuoteCommentCreatorType!
    value: String! @doc(description: "A simple (non-html) comment submitted by a seller or buyer")
}

enum NegotiableQuoteCommentCreatorType {
    BUYER
    SELLER
}

type NegotiableQuote {
    id: ID!
    name: String!
    items: [NegotiableQuoteItemInterface!]
    # Attachment Support is dependent on headless File Upload design
    # attachments: [AttachmentContent]
    comments: [NegotiableQuoteComment!]
    history: [NegotiableQuoteHistoryEntry!]
    prices: CartPrices
    buyer: NegotiableQuoteUser!
    created_at: String @doc(description: "Timestamp indicating when the negotiable quote was created.")
    updated_at: String @doc(description: "Timestamp indicating when the negotiable quote was updated.")
    status: NegotiableQuoteStatus!
}

# Implementation Note: Using the values from the "Buyer Status" column of the state mapping table in devdocs.
# These states are identical between storefront/admin, but we name them differently for buyers.
# https://devdocs.magento.com/guides/v2.4/b2b/negotiable-quote.html#quote-statuses
enum NegotiableQuoteStatus {
    SUBMITTED
    PENDING
    UPDATED
    OPEN
    ORDERED
    CLOSED
    DECLINED
    EXPIRED
}

input NegotiableQuoteFilterInput {
    ids: FilterEqualTypeInput @doc(description: "Filter by Negotiable Quote ID(s)")
    name: FilterMatchTypeInput @doc(description: "Filter by Negotiable Quote name")
}

interface NegotiableQuoteItemInterface {
    id: ID!
    quantity: Float!
    stock: Float
    price: CartItemPrices!
    product: ProductInterface
}

type DefaultNegotiableQuoteItem implements NegotiableQuoteItemInterface
@doc(description: "Negotiable Quote Item Implementation for Simple and Virtual Products") {
    id: ID! @doc(description: "Unique Identifier of Negotiable Quote Item")
    product: ProductInterface!
    qty: Float! @doc(description:  "Quantity added")
    customizable_options: [SelectedCustomizableOption] @doc(description: "custom Option selected")
}

type DownloadableRequisitionListItem implements NegotiableQuoteItemInterface
@doc(description: "Negotiable Quote Item Implementation that for Downloadable Products") {
    id: ID! @doc(description: "Unique Identifier of Negotiable Quote Item")
    product: ProductInterface!
    qty: Float! @doc(description: "Quantity added")
    customizable_options: [SelectedCustomizableOption] @doc(description:  "custom Option selected")
    links: [DownloadableProductLinks] @doc(description: "DownloadableProductLinks defines characteristics of a downloadable product")
    samples: [DownloadableProductSamples] @doc(description:  "DownloadableProductSamples defines characteristics of a downloadable product")
}

type BundleRequisitionListItem implements NegotiableQuoteItemInterface
@doc(description: "Negotiable Quote Item Implementation that for Bundle Products") {
    id: ID! @doc(description: "Unique Identifier of Negotiable Quote Item")
    product: ProductInterface!
    qty: Float! @doc(description: "Quantity added")
    customizable_options: [SelectedCustomizableOption] @doc(description: "custom Option selected")
    bundle_options: [SelectedBundleOption]! @doc(description: "selected bundle options")
}

type ConfigurableRequisitionListItem implements NegotiableQuoteItemInterface
@doc(description: "Negotiable Quote Item Implementation that for Configurable Products") {
    id: ID! @doc(description:  "Unique Identifier of Negotiable Quote Item")
    product: ProductInterface!
    qty: Float! @doc(description: "Quantity added")
    customizable_options: [SelectedCustomizableOption] @doc(description: "custom Option selected")
    configurable_options: [SelectedConfigurableOption] @doc(description: "Configurable options selected")
}

type NegotiableQuoteHistoryEntry {
    id: ID!
    author: NegotiableQuoteUser!
    change_type: NegotiableQuoteHistoryEntryChangeType!
    created_at: String
    changes: NegotiableQuoteHistoryChanges
}

# Note: Most of these HistoryChange types were built based on looking through UI code in Luma, because we don't have existing API
#       support for the Negotiable Quote history log feature. If we find these types aren't ideal during implementation,
#       let's iterate rather than stay glued to them.
#
#       Resources
#       Diffing class: https://github.com/magento/magento2b2b/blob/5547298c3dde48234ce74ed8ae9000fce3fe01b1/app/code/Magento/NegotiableQuote/Model/History/DiffProcessor.php
#       Block for UI:  https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/Block/Quote/History.php
#       Usage in UI:   https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml
#
#       There is currently no support for the `Custom Log` feature supported by the Luma UI, but we can add it on
#       https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml#L316-L363
#
# Implementation Note: Fields in NegotiableQuoteHistoryChanges should be null
#                      when no change is present
type NegotiableQuoteHistoryChanges {
    status: NegotiableQuoteHistoryStatusChange
    comment: NegotiableQuoteHistoryCommentChange
    total: NegotiableQuoteHistoryTotalChange
    expiration: NegotiableQuoteHistoryExpirationChange
    quantity: NegotiableQuoteHistoryQuantityChange
    products_removed: NegotiableQuoteHistoryProductsRemovedChange
    products_added: NegotiableQuoteHistoryProductsAddedChange
}

# Usage in Luma: https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml#L40-L73
type NegotiableQuoteHistoryStatusChange {
    old_status: NegotiableQuoteStatus @doc(description: "Will be null for the first history entry on a Negotiable Quote")
    new_status: NegotiableQuoteStatus!
}

# Usage in Luma: https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml#L239-L258
type NegotiableQuoteHistoryCommentChange {
    comment: String! @doc(description: "A simple (non-html) comment submitted by a seller or buyer")
}

# Usage in Luma: https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml#L259-L294
type NegotiableQuoteHistoryTotalChange {
    old_price: Money!
    new_price: Money!
}

# Usage in Luma: https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml#L74-L103
type NegotiableQuoteHistoryExpirationChange {
    old_expiration: String @doc(description: "Old quote expiration. Will be 'null' if not previously set")
    new_expiration: String!
}

# Usage in Luma: https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml#L104-L127
type NegotiableQuoteHistoryQuantityChange {
    # think it's just quantities?
}

# Usage in Luma: https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml#L132-L146
type NegotiableQuoteHistoryProductsRemovedChange {
    # Need to cover removal from catalog and removal from order
}

# Usage in Luma: https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml#L148-L169
type NegotiableQuoteHistoryProductsAddedChange {

}

# Usage in Luma: https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml#L172-L197
type NegotiableQuoteHistoryAddressChange {

}
# Usage in Luma: https://github.com/magento/magento2b2b/blob/0e791b5f7cd604ee6ee40b7225807c01b7f70cf2/app/code/Magento/NegotiableQuote/view/base/templates/quote/history.phtml#L316-L363
type NegotiableQuoteCustomLogChange {
    title: String!
    old_value: String
    new_value: String!
}

enum NegotiableQuoteHistoryEntryChangeType {
    CREATED
    UPDATED
    CLOSED
    UPDATED_BY_SYSTEM
}

type RequestNegotiableQuoteOutput {
    quote: NegotiableQuote
}

type RemoveNegotiableQuoteItemsOutput {
    quote: NegotiableQuote
}

type AddNegotiableQuoteCommentOutput {
    comment: NegotiableQuoteComment @doc(description: "The newly added comment")
    quote: NegotiableQuote
}

type UpdateNegotiableQuoteItemsQuantityOutput {
    quote: NegotiableQuote
}

# Implementation Note: We don't want to expose the `Customer` object of the Seller to the client, and we don't
# have much of a permissions model in the storefront to limit access by field. We're using a limited view
# instead, excluding the ID because a Seller's ID shouldn't be exposed to the client.
type NegotiableQuoteUser @doc(description: "A limited view of a Buyer or Seller in the Negotiable Quote Process") {
    firstname: String!
    lastname: String!
}
